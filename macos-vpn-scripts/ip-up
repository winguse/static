#!/bin/bash

if [ -f /etc/ppp/ip-script-disabled ]; then
  exit
fi

export PATH="/bin:/sbin:/usr/sbin:/usr/bin"
OLDGW=`netstat -nr | grep "^default" | grep -v "ppp" | head -n 1 | awk -F' ' '{print $2}'`
dscacheutil -flushcache
echo $OLDGW > /tmp/pptp_oldgw

# this list is generated by: bestroutetb --route.vpn=us -p mac -o .

route add 10.0.0.0/8 $OLDGW
route add 172.16.0.0/12 $OLDGW
route add 192.168.0.0/16 $OLDGW
route add 0.0.0.0/0 $4
route add 0.0.0.0/7 $OLDGW
route add 14.0.0.0/8 $OLDGW
route add 14.102.160.0/20 $4
route add 27.0.0.0/8 $OLDGW
route add 27.100.0.0/15 $4
route add 36.0.0.0/8 $OLDGW
route add 39.0.0.0/8 $OLDGW
route add 40.72.0.0/15 $OLDGW
route add 40.125.128.0/17 $OLDGW
route add 40.126.64.0/18 $OLDGW
route add 42.0.0.0/7 $OLDGW
route add 43.226.0.0/19 $4
route add 43.231.0.0/19 $4
route add 43.244.0.0/15 $4
route add 43.251.128.0/18 $4
route add 45.40.192.0/18 $OLDGW
route add 45.64.0.0/15 $OLDGW
route add 45.96.0.0/11 $OLDGW
route add 45.119.192.0/19 $4
route add 45.224.0.0/11 $OLDGW
route add 45.248.32.0/19 $4
route add 45.249.88.0/22 $4
route add 45.250.72.0/22 $4
route add 45.251.32.0/20 $4
route add 45.252.184.0/21 $4
route add 45.253.128.0/22 $4
route add 45.254.244.0/22 $4
route add 45.255.128.0/22 $4
route add 47.92.0.0/14 $OLDGW
route add 47.96.0.0/11 $OLDGW
route add 49.0.0.0/8 $OLDGW
route add 52.80.0.0/14 $OLDGW
route add 52.130.0.0/15 $OLDGW
route add 54.222.0.0/15 $OLDGW
route add 58.0.0.0/7 $OLDGW
route add 59.151.128.0/17 $4
route add 59.153.8.0/21 $4
route add 60.0.0.0/7 $OLDGW
route add 60.254.0.0/16 $4
route add 62.128.0.0/9 $OLDGW
route add 68.79.0.0/18 $OLDGW
route add 69.230.192.0/18 $OLDGW
route add 69.231.128.0/18 $OLDGW
route add 69.234.192.0/18 $OLDGW
route add 69.235.128.0/18 $OLDGW
route add 71.131.192.0/18 $OLDGW
route add 71.132.0.0/18 $OLDGW
route add 71.136.64.0/18 $OLDGW
route add 71.137.0.0/18 $OLDGW
route add 81.64.0.0/12 $OLDGW
route add 82.128.0.0/9 $OLDGW
route add 91.234.0.0/16 $OLDGW
route add 94.184.0.0/13 $OLDGW
route add 101.0.0.0/8 $OLDGW
route add 101.53.128.0/17 $4
route add 102.0.0.0/7 $OLDGW
route add 103.6.80.0/20 $4
route add 103.11.64.0/18 $4
route add 103.12.192.0/19 $4
route add 103.15.112.0/20 $4
route add 103.19.80.0/20 $4
route add 103.21.244.0/22 $4
route add 103.22.192.0/19 $4
route add 103.25.224.0/19 $4
route add 103.28.64.0/18 $4
route add 103.31.4.0/22 $4
route add 103.35.120.0/21 $4
route add 103.47.56.0/21 $4
route add 103.60.0.0/19 $4
route add 103.66.0.0/19 $4
route add 103.67.32.0/19 $4
route add 103.67.200.0/21 $4
route add 103.68.112.0/20 $4
route add 103.70.32.0/19 $4
route add 103.71.16.0/20 $4
route add 103.72.64.0/19 $4
route add 103.73.64.0/20 $4
route add 103.78.120.0/22 $4
route add 103.83.192.0/18 $4
route add 103.84.144.0/20 $4
route add 103.85.40.0/22 $4
route add 103.87.104.0/21 $4
route add 103.89.64.0/19 $4
route add 103.91.48.0/20 $4
route add 103.91.104.0/22 $4
route add 103.92.208.0/20 $4
route add 103.97.240.0/20 $4
route add 103.98.172.0/22 $4
route add 103.101.0.0/22 $4
route add 103.102.160.0/21 $4
route add 103.103.48.0/20 $4
route add 103.103.240.0/21 $4
route add 103.104.128.0/20 $4
route add 103.111.32.0/22 $4
route add 103.111.176.0/20 $4
route add 103.115.96.0/20 $4
route add 103.116.16.0/22 $4
route add 103.117.96.0/19 $4
route add 103.121.192.0/19 $4
route add 103.123.128.0/19 $4
route add 103.124.96.0/19 $4
route add 103.124.128.0/18 $4
route add 103.126.136.0/21 $4
route add 103.129.64.0/18 $4
route add 103.131.64.0/18 $4
route add 103.134.128.0/18 $4
route add 103.135.0.0/18 $4
route add 103.140.16.0/20 $4
route add 103.140.160.0/19 $4
route add 103.141.32.0/22 $4
route add 103.141.160.0/20 $4
route add 103.141.192.0/19 $4
route add 103.142.192.0/20 $4
route add 103.142.222.0/23 $4
route add 103.143.30.0/24 $4
route add 103.143.32.0/19 $4
route add 103.143.76.0/22 $4
route add 103.147.64.0/19 $4
route add 103.148.192.0/18 $4
route add 103.196.0.0/19 $4
route add 103.196.176.0/20 $4
route add 103.206.64.0/19 $4
route add 103.211.176.0/20 $4
route add 103.211.252.0/22 $4
route add 103.216.192.0/19 $4
route add 103.217.224.0/19 $4
route add 103.219.72.0/21 $4
route add 103.219.192.0/18 $4
route add 103.228.96.0/19 $4
route add 103.230.64.0/19 $4
route add 103.231.24.0/21 $4
route add 103.232.192.0/20 $4
route add 103.237.32.0/19 $4
route add 103.240.192.0/19 $4
route add 103.242.192.0/21 $4
route add 103.246.192.0/18 $4
route add 103.247.0.0/17 $4
route add 103.254.160.0/20 $4
route add 103.254.198.0/23 $4
route add 106.0.0.0/8 $OLDGW
route add 109.128.0.0/9 $OLDGW
route add 110.0.0.0/7 $OLDGW
route add 112.0.0.0/4 $OLDGW
route add 113.28.0.0/15 $4
route add 116.206.64.0/20 $4
route add 122.252.0.0/15 $4
route add 123.253.64.0/19 $4
route add 123.253.104.0/22 $4
route add 123.253.128.0/18 $4
route add 128.108.0.0/16 $OLDGW
route add 129.28.0.0/16 $OLDGW
route add 129.204.0.0/15 $OLDGW
route add 129.211.0.0/16 $OLDGW
route add 132.232.0.0/16 $OLDGW
route add 134.175.0.0/16 $OLDGW
route add 137.58.0.0/15 $OLDGW
route add 139.0.0.0/12 $OLDGW
route add 139.128.0.0/15 $OLDGW
route add 139.148.0.0/15 $OLDGW
route add 139.152.0.0/13 $OLDGW
route add 139.170.0.0/16 $OLDGW
route add 139.176.0.0/16 $OLDGW
route add 139.183.0.0/16 $OLDGW
route add 139.186.0.0/16 $OLDGW
route add 139.188.0.0/14 $OLDGW
route add 139.192.0.0/11 $OLDGW
route add 139.224.0.0/16 $OLDGW
route add 139.226.0.0/15 $OLDGW
route add 140.75.0.0/16 $OLDGW
route add 140.143.0.0/16 $OLDGW
route add 140.179.0.0/16 $OLDGW
route add 140.205.0.0/16 $OLDGW
route add 140.206.0.0/15 $OLDGW
route add 140.210.0.0/16 $OLDGW
route add 140.224.0.0/16 $OLDGW
route add 140.237.0.0/16 $OLDGW
route add 140.240.0.0/16 $OLDGW
route add 140.243.0.0/16 $OLDGW
route add 140.246.0.0/16 $OLDGW
route add 140.249.0.0/16 $OLDGW
route add 140.250.0.0/16 $OLDGW
route add 140.255.0.0/16 $OLDGW
route add 144.0.0.0/15 $OLDGW
route add 144.6.0.0/15 $OLDGW
route add 144.12.0.0/16 $OLDGW
route add 144.48.0.0/16 $OLDGW
route add 144.52.0.0/14 $OLDGW
route add 144.122.0.0/15 $OLDGW
route add 144.255.0.0/16 $OLDGW
route add 146.56.0.0/16 $OLDGW
route add 146.196.0.0/16 $OLDGW
route add 146.196.96.0/20 $4
route add 148.68.0.0/14 $OLDGW
route add 150.0.0.0/10 $OLDGW
route add 150.115.0.0/16 $OLDGW
route add 150.121.0.0/16 $OLDGW
route add 150.122.0.0/16 $OLDGW
route add 150.128.0.0/15 $OLDGW
route add 150.138.0.0/15 $OLDGW
route add 150.158.0.0/16 $OLDGW
route add 150.223.0.0/16 $OLDGW
route add 150.242.0.0/16 $OLDGW
route add 150.254.0.0/15 $OLDGW
route add 152.104.0.0/13 $OLDGW
route add 152.136.0.0/16 $OLDGW
route add 153.0.0.0/15 $OLDGW
route add 153.3.0.0/16 $OLDGW
route add 153.34.0.0/15 $OLDGW
route add 153.36.0.0/15 $OLDGW
route add 153.96.0.0/14 $OLDGW
route add 153.100.0.0/15 $OLDGW
route add 153.118.0.0/15 $OLDGW
route add 154.8.0.0/16 $OLDGW
route add 157.0.0.0/12 $OLDGW
route add 157.16.0.0/14 $OLDGW
route add 157.61.0.0/16 $OLDGW
route add 157.112.0.0/13 $OLDGW
route add 157.122.0.0/16 $OLDGW
route add 157.148.0.0/16 $OLDGW
route add 157.156.0.0/14 $OLDGW
route add 157.255.0.0/16 $OLDGW
route add 159.75.0.0/16 $OLDGW
route add 159.226.0.0/16 $OLDGW
route add 160.19.192.0/18 $OLDGW
route add 160.20.0.0/17 $OLDGW
route add 160.202.32.0/19 $OLDGW
route add 160.202.128.0/17 $OLDGW
route add 160.238.64.0/22 $OLDGW
route add 161.189.0.0/16 $OLDGW
route add 161.207.0.0/16 $OLDGW
route add 162.14.0.0/16 $OLDGW
route add 162.105.0.0/16 $OLDGW
route add 163.0.0.0/15 $OLDGW
route add 163.47.0.0/17 $OLDGW
route add 163.48.0.0/12 $OLDGW
route add 163.125.0.0/16 $OLDGW
route add 163.136.0.0/13 $OLDGW
route add 163.177.0.0/16 $OLDGW
route add 163.178.0.0/15 $OLDGW
route add 163.204.0.0/16 $OLDGW
route add 164.52.0.0/17 $OLDGW
route add 166.110.0.0/15 $OLDGW
route add 167.139.0.0/16 $OLDGW
route add 167.189.0.0/16 $OLDGW
route add 167.220.240.0/21 $OLDGW
route add 168.160.0.0/16 $OLDGW
route add 170.179.0.0/16 $OLDGW
route add 171.0.0.0/9 $OLDGW
route add 171.64.0.0/12 $4
route add 171.208.0.0/12 $OLDGW
route add 172.81.192.0/18 $OLDGW
route add 175.0.0.0/8 $OLDGW
route add 180.0.0.0/6 $OLDGW
route add 182.50.64.0/19 $4
route add 182.54.128.0/18 $4
route add 185.203.0.0/16 $OLDGW
route add 188.128.0.0/10 $OLDGW
route add 192.51.128.0/18 $OLDGW
route add 192.55.46.0/24 $OLDGW
route add 192.55.68.0/22 $OLDGW
route add 192.102.204.0/23 $OLDGW
route add 192.124.154.0/23 $OLDGW
route add 192.140.128.0/17 $OLDGW
route add 192.144.0.0/16 $OLDGW
route add 192.197.112.0/21 $OLDGW
route add 193.112.0.0/13 $OLDGW
route add 198.175.100.0/22 $OLDGW
route add 199.212.57.0/24 $OLDGW
route add 202.0.0.0/7 $OLDGW
route add 202.5.0.0/17 $4
route add 202.43.80.0/20 $4
route add 202.65.16.0/20 $4
route add 202.72.96.0/20 $4
route add 202.74.54.0/23 $4
route add 202.129.224.0/19 $4
route add 202.136.64.0/18 $4
route add 202.165.0.0/17 $4
route add 202.173.16.0/20 $4
route add 202.173.116.0/22 $4
route add 202.182.64.0/18 $4
route add 203.24.246.0/23 $4
route add 203.28.240.0/20 $4
route add 203.33.152.0/22 $4
route add 203.55.64.0/20 $4
route add 203.62.176.0/20 $4
route add 203.98.0.0/16 $4
route add 203.144.0.0/18 $4
route add 203.187.128.0/19 $4
route add 204.52.191.0/24 $OLDGW
route add 210.0.0.0/7 $OLDGW
route add 212.64.0.0/14 $OLDGW
route add 212.128.0.0/9 $OLDGW
route add 218.0.0.0/7 $OLDGW
route add 220.0.0.0/6 $OLDGW



LOCAL_DNS="$OLDGW:53" # Gateway usually is the DNS, change it if needed
VPN_DNS="8.8.8.8:53"

/usr/local/bin/another-dns \
  -local-dns $LOCAL_DNS \
  -local-ip-list-file /etc/ppp/cn-cidrs.txt \
  -vpn-dns $VPN_DNS \
  -port 53 &

echo $! > /tmp/another-dns.pid


SERVICE_ID=`echo 'open
get State:/Network/Global/IPv4
d.show
quit' | scutil | grep PrimaryService | awk '{print $3}'`


echo "open
d.init
d.add ServerAddresses * 127.0.0.1
set State:/Network/Service/$SERVICE_ID/DNS
quit" | scutil


